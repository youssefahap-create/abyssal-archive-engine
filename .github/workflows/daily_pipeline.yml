name: Daily YouTube Automation

on:
  schedule:
    # تشغيل كل يوم في الساعة 07:00 UTC (قبل ساعة من أول شورت)
    - cron: '0 7 * * *'
  workflow_dispatch:  # للتشغيل اليدوي
    inputs:
      test_mode:
        description: 'Run in test mode?'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  generate-and-upload:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3 ساعات كحد أقصى
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg libsm6 libxext6 libgl1-mesa-glx

    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create environment file from secrets
      env:
        ALL_SECRETS: ${{ toJson(secrets) }}
      run: |
        # إنشاء ملف .env من جميع Secrets
        echo "# Auto-generated from GitHub Secrets" > .env
        echo "# Generated on $(date)" >> .env
        echo "" >> .env
        
        # إضافة جميع الـ Secrets كمتغيرات بيئة
        python3 -c "
import json
import os

secrets = json.loads(os.environ['ALL_SECRETS'])
with open('.env', 'a') as f:
    for key, value in secrets.items():
        if value:  # فقط إذا كانت القيمة ليست فارغة
            f.write(f'{key}={value}\\n')
        
        # إضافة متغيرات النظام
        f.write('''
LOG_LEVEL=INFO
TEST_MODE=${{ github.event.inputs.test_mode }}
MAX_VIDEO_SIZE_MB=500
CLEANUP_OLD_FILES_DAYS=7
GITHUB_ACTIONS=true
''')
        "

    - name: Create necessary directories
      run: |
        mkdir -p assets/backgrounds
        mkdir -p assets/local_images
        mkdir -p assets/local_audio
        mkdir -p assets/generated/images
        mkdir -p assets/generated/audio
        mkdir -p assets/generated/videos
        mkdir -p assets/generated/shorts
        mkdir -p assets/uploads
        mkdir -p database
        mkdir -p logs
        mkdir -p backups

    - name: Generate default backgrounds
      run: |
        python3 -c "
from PIL import Image, ImageDraw
import os

# ألوان خلفيات
colors = [
    (41, 128, 185),    # أزرق
    (39, 174, 96),     # أخضر
    (142, 68, 173),    # بنفسجي
    (230, 126, 34),    # برتقالي
    (231, 76, 60),     # أحمر
    (52, 73, 94),      # رمادي داكن
    (26, 188, 156),    # تركواز
    (241, 196, 15),    # أصفر
]

os.makedirs('assets/backgrounds', exist_ok=True)

for i, color in enumerate(colors):
    img = Image.new('RGB', (1080, 1920), color)
    draw = ImageDraw.Draw(img)
    
    # إضافة نمط بسيط
    for x in range(0, 1080, 100):
        for y in range(0, 1920, 100):
            if (x + y) % 200 == 0:
                draw.rectangle([x, y, x+50, y+50], fill=(255, 255, 255, 50))
    
    img.save(f'assets/backgrounds/background_{i+1}.png')

print(f'Created {len(colors)} default backgrounds')
        "

    - name: Create local questions file
      run: |
        python3 -c "
import json

questions = [
    {
        'question': 'What is the capital of France?',
        'answer': 'Paris',
        'category': 'general_knowledge',
        'difficulty': 'easy',
        'image_prompt': 'Eiffel Tower in Paris'
    },
    {
        'question': 'How many continents are there?',
        'answer': '7',
        'category': 'general_knowledge',
        'difficulty': 'easy',
        'image_prompt': 'World map with continents'
    },
    {
        'question': 'What is the largest planet in our solar system?',
        'answer': 'Jupiter',
        'category': 'general_knowledge',
        'difficulty': 'medium',
        'image_prompt': 'Jupiter planet in space'
    },
    {
        'question': 'Which country has a flag with a red circle on white background?',
        'answer': 'Japan',
        'category': 'flags',
        'difficulty': 'easy',
        'image_prompt': 'Japanese flag with red circle'
    },
    {
        'question': 'What animal is known as the King of the Jungle?',
        'answer': 'Lion',
        'category': 'animals',
        'difficulty': 'easy',
        'image_prompt': 'Lion in the jungle'
    }
]

os.makedirs('assets', exist_ok=True)
with open('assets/local_questions.json', 'w', encoding='utf-8') as f:
    json.dump(questions, f, indent=2, ensure_ascii=False)
print(f'Created {len(questions)} local questions')
        "

    - name: Test system components
      run: |
        python main.py --test-all

    - name: Run daily pipeline
      env:
        TEST_MODE: ${{ github.event.inputs.test_mode }}
      run: |
        if [ "$TEST_MODE" = "true" ]; then
          echo "Running in TEST MODE"
          python main.py --test --run-once
        else
          echo "Running in PRODUCTION MODE"
          python main.py --run-once
        fi

    - name: Upload logs as artifact
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: daily-logs
        path: logs/
        retention-days: 7

    - name: Upload generated videos
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: generated-videos
        path: |
          assets/generated/shorts/
          assets/generated/videos/
        retention-days: 3

    - name: Send Telegram notification
      if: always() && secrets.TELEGRAM_BOT_TOKEN != ''
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        if [ -f "logs/background.log" ]; then
          LAST_LINES=$(tail -3 logs/background.log)
          STATUS="$1"
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
          -d chat_id="$TELEGRAM_CHAT_ID" \
          -d text="YouTube Auto Pipeline $STATUS
          
          Last logs:
          $LAST_LINES"
        fi
