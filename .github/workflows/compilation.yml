name: Compilation Video

on:
  schedule:
    # ØªØ´ØºÙŠÙ„ ÙƒÙ„ ÙŠÙˆÙ… ÙÙŠ Ø§Ù„Ø³Ø§Ø¹Ø© 22:00 UTC
    - cron: '0 22 * * *'
  workflow_dispatch:

jobs:
  create-compilation:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg

    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create environment file
      run: |
        cat > .env << EOF
        # YouTube API
        YOUTUBE_API_KEY=${{ secrets.YOUTUBE_API_KEY }}
        YT_CHANNEL_ID=${{ secrets.YT_CHANNEL_ID }}
        YT_CLIENT_ID_1=${{ secrets.YT_CLIENT_ID_1 }}
        YT_CLIENT_SECRET_1=${{ secrets.YT_CLIENT_SECRET_1 }}
        YT_REFRESH_TOKEN_1=${{ secrets.YT_REFRESH_TOKEN_1 }}
        
        # System Settings
        LOG_LEVEL=INFO
        TEST_MODE=false
        GITHUB_ACTIONS=true
        EOF

    - name: Create compilation video
      run: |
        python3 -c "
import sys
sys.path.append('.')
from core.video_editor import VideoEditor
from core.youtube_uploader import YouTubeUploader
from datetime import datetime, timedelta
import glob
import json
import os

print('ğŸš€ Starting compilation video creation...')

# Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø´ÙˆØ±ØªØ§Øª Ø§Ù„Ù…ÙˆÙ„Ø¯Ø© Ø§Ù„ÙŠÙˆÙ…
short_files = []
for ext in ['*.mp4', '*.mov', '*.avi']:
    short_files.extend(glob.glob(f'assets/generated/shorts/{ext}'))

print(f'ğŸ“ Found {len(short_files)} short videos')

if len(short_files) >= 2:
    # Ø£Ø®Ø° Ø£Ø­Ø¯Ø« 4 Ø´ÙˆØ±ØªØ§Øª
    latest_shorts = sorted(short_files, key=os.path.getmtime, reverse=True)[:4]
    print(f'ğŸ¬ Using {len(latest_shorts)} shorts for compilation')
    
    video_editor = VideoEditor()
    youtube_uploader = YouTubeUploader()
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØªØ¬Ù…ÙŠØ¹ÙŠ
    compilation_path = video_editor.create_compilation_video(latest_shorts)
    
    if compilation_path and os.path.exists(compilation_path):
        print(f'âœ… Compilation created: {compilation_path}')
        
        # Ø­Ø³Ø§Ø¨ ÙˆÙ‚Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© (22:00 UTC)
        hour = 22
        today = datetime.utcnow().date()
        schedule_time = datetime.combine(today, datetime.min.time()).replace(hour=hour)
        
        # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆÙ‚Øª Ù‚Ø¯ ÙØ§ØªØŒ Ù†Ø¶ÙŠÙ ÙŠÙˆÙ…
        if schedule_time < datetime.utcnow():
            schedule_time += timedelta(days=1)
        
        print(f'â° Scheduled for: {schedule_time}')
        
        # Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„ØªØ¬Ù…ÙŠØ¹ÙŠ
        youtube_video_id = youtube_uploader.upload_compilation(
            video_path=compilation_path,
            shorts_data=[{'question': f'Short {i+1}'} for i in range(len(latest_shorts))],
            schedule_time=schedule_time
        )
        
        if youtube_video_id:
            print(f'ğŸ‰ Compilation uploaded successfully! Video ID: {youtube_video_id}')
            
            # Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±ÙØ¹
            upload_info = {
                'youtube_id': youtube_video_id,
                'compilation_path': compilation_path,
                'shorts_used': len(latest_shorts),
                'upload_time': datetime.now().isoformat(),
                'scheduled_time': schedule_time.isoformat()
            }
            
            with open('upload_info_compilation.json', 'w') as f:
                json.dump(upload_info, f, indent=2)
        else:
            print('âŒ Failed to upload compilation')
    else:
        print('âŒ Failed to create compilation video')
else:
    print(f'âš ï¸ Not enough short videos found: {len(short_files)} (need at least 2)')
        "

    - name: Upload compilation info
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: compilation-info
        path: upload_info_compilation.json
        retention-days: 7

    - name: Send compilation notification
      if: success() && secrets.TELEGRAM_BOT_TOKEN != ''
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        if [ -f "upload_info_compilation.json" ]; then
          INFO=$(cat upload_info_compilation.json)
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
          -d chat_id="$TELEGRAM_CHAT_ID" \
          -d text="âœ… Compilation video uploaded successfully!
          
          $INFO"
        fi
