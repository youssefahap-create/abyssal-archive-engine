name: Shorts Scheduler

on:
  schedule:
    # ØªØ´ØºÙŠÙ„ Ø§Ù„Ø´ÙˆØ±ØªØ§Øª ÙÙŠ Ø£ÙˆÙ‚Ø§ØªÙ‡Ø§ (Ø¨ØªÙˆÙ‚ÙŠØª UTC)
    - cron: '0 8 * * *'   # 08:00 UTC = Ø§Ù„Ø´ÙˆØ±Øª Ø§Ù„Ø£ÙˆÙ„
    - cron: '0 12 * * *'  # 12:00 UTC = Ø§Ù„Ø´ÙˆØ±Øª Ø§Ù„Ø«Ø§Ù†ÙŠ
    - cron: '0 16 * * *'  # 16:00 UTC = Ø§Ù„Ø´ÙˆØ±Øª Ø§Ù„Ø«Ø§Ù„Ø«
    - cron: '0 20 * * *'  # 20:00 UTC = Ø§Ù„Ø´ÙˆØ±Øª Ø§Ù„Ø±Ø§Ø¨Ø¹
  workflow_dispatch:
    inputs:
      short_number:
        description: 'Short number (1-4)'
        required: true
        type: choice
        options:
        - '1'
        - '2'
        - '3'
        - '4'

jobs:
  upload-short:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg

    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt

    - name: Create environment file from secrets
      run: |
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù .env Ù…Ø¹ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙ‚Ø·
        cat > .env << EOF
        # YouTube API (Ø§Ù„Ø£Ù‡Ù…)
        YOUTUBE_API_KEY=${{ secrets.YOUTUBE_API_KEY }}
        YT_CHANNEL_ID=${{ secrets.YT_CHANNEL_ID }}
        YT_CLIENT_ID_1=${{ secrets.YT_CLIENT_ID_1 }}
        YT_CLIENT_SECRET_1=${{ secrets.YT_CLIENT_SECRET_1 }}
        YT_REFRESH_TOKEN_1=${{ secrets.YT_REFRESH_TOKEN_1 }}
        
        # Fallback YouTube credentials
        YT_CLIENT_ID_2=${{ secrets.YT_CLIENT_ID_2 }}
        YT_CLIENT_SECRET_2=${{ secrets.YT_CLIENT_SECRET_2 }}
        YT_REFRESH_TOKEN_2=${{ secrets.YT_REFRESH_TOKEN_2 }}
        
        # AI Content (Ø£Ø¶Ù Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…ØªØ§Ø­Ø©)
        GEMINI_API_KEY_1=${{ secrets.GEMINI_API_KEY_1 }}
        OPENAI_API_KEY_1=${{ secrets.OPENAI_API_KEY_1 }}
        GROQ_API_KEY=${{ secrets.GROQ_API_KEY }}
        
        # Text-to-Speech
        ELEVEN_API_KEY_1=${{ secrets.ELEVEN_API_KEY_1 }}
        
        # Image APIs
        GETIMG_API_KEY_1=${{ secrets.GETIMG_API_KEY_1 }}
        PEXELS_API_KEY=${{ secrets.PEXELS_API_KEY }}
        PIXABAY_API_KEY=${{ secrets.PIXABAY_API_KEY }}
        
        # System Settings
        LOG_LEVEL=INFO
        TEST_MODE=false
        GITHUB_ACTIONS=true
        EOF

    - name: Determine short number
      id: determine_short
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          echo "SHORT_NUMBER=${{ github.event.inputs.short_number }}" >> $GITHUB_ENV
        else
          # ØªØ­Ø¯ÙŠØ¯ Ø±Ù‚Ù… Ø§Ù„Ø´ÙˆØ±Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ÙˆÙ‚Øª Ø§Ù„ØªØ´ØºÙŠÙ„
          HOUR=$(date -u +%H)
          case $HOUR in
            "08") SHORT_NUM=1 ;;
            "12") SHORT_NUM=2 ;;
            "16") SHORT_NUM=3 ;;
            "20") SHORT_NUM=4 ;;
            *) SHORT_NUM=1 ;;
          esac
          echo "SHORT_NUMBER=$SHORT_NUM" >> $GITHUB_ENV
        fi
        echo "Processing short number: $SHORT_NUMBER"

    - name: Generate single short
      run: |
        python3 -c "
import sys
import os
sys.path.append('.')

# ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø´ÙˆØ±Øª ÙˆØ§Ø­Ø¯
from core.content_generator import ContentGenerator
from core.video_editor import VideoEditor
from core.youtube_uploader import YouTubeUploader
from services.seo_optimizer import SEOOptimizer
from datetime import datetime, timedelta
import json

print(f'ğŸš€ Starting short generation for short #{sys.argv[1]}')

# ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª
content_gen = ContentGenerator()
video_editor = VideoEditor()
youtube_uploader = YouTubeUploader()
seo_optimizer = SEOOptimizer()

# ØªÙˆÙ„ÙŠØ¯ Ø³Ø¤Ø§Ù„
question_data = content_gen.generate_question()
print(f'ğŸ“ Question generated: {question_data[\"question\"]}')

# Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
print('ğŸ¬ Creating video...')
video_path = video_editor.create_short_video(question_data)

if video_path and os.path.exists(video_path):
    print(f'âœ… Video created: {video_path}')
    
    # Ø­Ø³Ø§Ø¨ ÙˆÙ‚Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©
    short_num = int(sys.argv[1])
    schedule_hours = [8, 12, 16, 20]  # Ø¨ØªÙˆÙ‚ÙŠØª UTC
    if short_num <= len(schedule_hours):
        hour = schedule_hours[short_num - 1]
        today = datetime.utcnow().date()
        schedule_time = datetime.combine(today, datetime.min.time()).replace(hour=hour)
        
        # Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙˆÙ‚Øª Ù‚Ø¯ ÙØ§ØªØŒ Ù†Ø¶ÙŠÙ ÙŠÙˆÙ…
        if schedule_time < datetime.utcnow():
            schedule_time += timedelta(days=1)
            
        print(f'â° Scheduled for: {schedule_time}')
    else:
        schedule_time = None
    
    # Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
    print('ğŸ“¤ Uploading to YouTube...')
    youtube_video_id = youtube_uploader.upload_short(
        video_path=video_path,
        question_data=question_data,
        schedule_time=schedule_time
    )
    
    if youtube_video_id:
        print(f'ğŸ‰ Short uploaded successfully! Video ID: {youtube_video_id}')
        
        # Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø±ÙØ¹
        upload_info = {
            'short_number': short_num,
            'youtube_id': youtube_video_id,
            'question': question_data['question'],
            'upload_time': datetime.now().isoformat(),
            'scheduled_time': schedule_time.isoformat() if schedule_time else None
        }
        
        with open(f'upload_info_short_{short_num}.json', 'w') as f:
            json.dump(upload_info, f, indent=2)
    else:
        print('âŒ Failed to upload short')
else:
    print('âŒ Failed to create video')
        " ${{ env.SHORT_NUMBER }}

    - name: Upload short info
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: short-${{ env.SHORT_NUMBER }}-info
        path: upload_info_short_*.json
        retention-days: 7

    - name: Send success notification
      if: success() && secrets.TELEGRAM_BOT_TOKEN != ''
      env:
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      run: |
        if [ -f "upload_info_short_${{ env.SHORT_NUMBER }}.json" ]; then
          INFO=$(cat upload_info_short_${{ env.SHORT_NUMBER }}.json)
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
          -d chat_id="$TELEGRAM_CHAT_ID" \
          -d text="âœ… Short ${{ env.SHORT_NUMBER }} uploaded successfully!
          
          $INFO"
        fi
